# GitOps Infrastructure Management Workflow
# Manages Terraform infrastructure with plan/apply automation and drift detection
# Demonstrates Infrastructure as Code (IaC) principles in GitOps

name: Infrastructure Management

# GitOps Triggers: Infrastructure changes and scheduled drift detection
on:
  # Manual trigger for infrastructure operations
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy

  # Automatic trigger on infrastructure code changes
  push:
    paths:
      - 'devops/terraform/**'
    branches: [main, develop]

  # Scheduled drift detection (GitOps principle: continuous reconciliation)
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday at 6 AM UTC

# Required permissions for infrastructure management
permissions:
  contents: read
  id-token: write
  pull-requests: write  # For commenting on PRs with plan results

env:
  TF_VERSION: 1.6.0

jobs:
  # Job 1: Terraform Plan
  # GitOps: Always plan before apply to show intended changes
  terraform-plan:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        # Plan for all environments to detect drift
        environment: [dev, staging, prod]
    
    outputs:
      plan-dev: ${{ steps.plan.outputs.plan-dev }}
      plan-staging: ${{ steps.plan.outputs.plan-staging }}
      plan-prod: ${{ steps.plan.outputs.plan-prod }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Configure AWS credentials using OIDC
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsRole-${{ matrix.environment }}
          aws-region: us-west-2
          role-session-name: terraform-${{ matrix.environment }}-${{ github.run_id }}

      # Setup Terraform with version pinning
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false  # Needed for output parsing

      # Initialize Terraform with remote state
      - name: Terraform Init
        working-directory: devops/terraform/environments/${{ matrix.environment }}
        run: |
          # GitOps: Remote state enables team collaboration and state locking
          terraform init \
            -backend-config="bucket=terraform-state-${{ secrets.AWS_ACCOUNT_ID }}-${{ matrix.environment }}" \
            -backend-config="key=expenses-app/${{ matrix.environment }}/terraform.tfstate" \
            -backend-config="region=us-west-2"

      # Validate Terraform configuration
      - name: Terraform Validate
        working-directory: devops/terraform/environments/${{ matrix.environment }}
        run: terraform validate

      # Format check (GitOps: Consistent code formatting)
      - name: Terraform Format Check
        working-directory: devops/terraform/environments/${{ matrix.environment }}
        run: terraform fmt -check -recursive

      # Security scan with Checkov
      - name: Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: devops/terraform/environments/${{ matrix.environment }}
          framework: terraform
          output_format: sarif
          output_file_path: checkov-${{ matrix.environment }}.sarif
        continue-on-error: true

      # Upload security scan results
      - name: Upload security scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-${{ matrix.environment }}.sarif
          category: terraform-${{ matrix.environment }}
        if: always()

      # Generate Terraform plan
      - name: Terraform Plan
        id: plan
        working-directory: devops/terraform/environments/${{ matrix.environment }}
        run: |
          # Generate plan with detailed output
          terraform plan \
            -detailed-exitcode \
            -out=tfplan-${{ matrix.environment }} \
            -var="environment=${{ matrix.environment }}" \
            -var="db_password=${{ secrets[format('{0}_DB_PASSWORD', matrix.environment | upper)] }}" \
            > plan-output.txt 2>&1
          
          # Capture exit code (0=no changes, 1=error, 2=changes)
          PLAN_EXIT_CODE=$?
          echo "plan-exit-code=$PLAN_EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Set output for matrix environment
          echo "plan-${{ matrix.environment }}=$PLAN_EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Save plan output for PR comment
          if [ "$PLAN_EXIT_CODE" -eq 2 ]; then
            echo "## 📋 Terraform Plan - ${{ matrix.environment }}" >> plan-summary.md
            echo '```terraform' >> plan-summary.md
            cat plan-output.txt >> plan-summary.md
            echo '```' >> plan-summary.md
          elif [ "$PLAN_EXIT_CODE" -eq 0 ]; then
            echo "## ✅ No changes - ${{ matrix.environment }}" >> plan-summary.md
            echo "Infrastructure is up to date." >> plan-summary.md
          fi

      # Upload plan artifacts
      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ matrix.environment }}
          path: |
            devops/terraform/environments/${{ matrix.environment }}/tfplan-${{ matrix.environment }}
            devops/terraform/environments/${{ matrix.environment }}/plan-summary.md
        if: always()

      # Comment on PR with plan results (if this is a PR)
      - name: Comment PR with plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const path = 'devops/terraform/environments/${{ matrix.environment }}/plan-summary.md';
            
            if (fs.existsSync(path)) {
              const plan = fs.readFileSync(path, 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: plan
              });
            }

  # Job 2: Terraform Apply (Manual approval required for prod)
  # GitOps: Controlled deployment with approval gates
  terraform-apply:
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    # Production requires manual approval
    environment: 
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: ${{ steps.deploy.outputs.application_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsRole-${{ github.event.inputs.environment || 'dev' }}
          aws-region: us-west-2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Download plan from previous job
      - name: Download plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment || 'dev' }}
          path: devops/terraform/environments/${{ github.event.inputs.environment || 'dev' }}

      - name: Terraform Init
        working-directory: devops/terraform/environments/${{ github.event.inputs.environment || 'dev' }}
        run: |
          terraform init \
            -backend-config="bucket=terraform-state-${{ secrets.AWS_ACCOUNT_ID }}-${{ github.event.inputs.environment || 'dev' }}" \
            -backend-config="key=expenses-app/${{ github.event.inputs.environment || 'dev' }}/terraform.tfstate" \
            -backend-config="region=us-west-2"

      # Apply the planned changes
      - name: Terraform Apply
        id: deploy
        working-directory: devops/terraform/environments/${{ github.event.inputs.environment || 'dev' }}
        run: |
          # Apply the previously generated plan
          terraform apply tfplan-${{ github.event.inputs.environment || 'dev' }}
          
          # Get outputs for verification
          ALB_DNS=$(terraform output -raw alb_dns_name 2>/dev/null || echo "")
          if [ -n "$ALB_DNS" ]; then
            echo "application_url=http://$ALB_DNS" >> $GITHUB_OUTPUT
          fi

      # Verify infrastructure deployment
      - name: Verify deployment
        run: |
          echo "## 🏗️ Infrastructure Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Version**: ${{ env.TF_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.deploy.outputs.application_url }}" ]; then
            echo "- **Application URL**: ${{ steps.deploy.outputs.application_url }}" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 3: Drift Detection
  # GitOps: Continuous monitoring for configuration drift
  drift-detection:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    strategy:
      matrix:
        environment: [dev, staging, prod]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsRole-${{ matrix.environment }}
          aws-region: us-west-2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: devops/terraform/environments/${{ matrix.environment }}
        run: |
          terraform init \
            -backend-config="bucket=terraform-state-${{ secrets.AWS_ACCOUNT_ID }}-${{ matrix.environment }}" \
            -backend-config="key=expenses-app/${{ matrix.environment }}/terraform.tfstate" \
            -backend-config="region=us-west-2"

      # Detect configuration drift
      - name: Detect drift
        working-directory: devops/terraform/environments/${{ matrix.environment }}
        run: |
          # Run plan to detect drift
          terraform plan \
            -detailed-exitcode \
            -var="environment=${{ matrix.environment }}" \
            -var="db_password=${{ secrets[format('{0}_DB_PASSWORD', matrix.environment | upper)] }}" \
            > drift-report.txt 2>&1
          
          DRIFT_EXIT_CODE=$?
          
          if [ $DRIFT_EXIT_CODE -eq 2 ]; then
            echo "⚠️ Configuration drift detected in ${{ matrix.environment }}"
            
            # Create GitHub issue for drift
            gh issue create \
              --title "Configuration Drift Detected - ${{ matrix.environment }}" \
              --body "$(cat drift-report.txt)" \
              --label "infrastructure,drift,${{ matrix.environment }}"
          else
            echo "✅ No drift detected in ${{ matrix.environment }}"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}